<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authentication App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-orange-50 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
    <h2 class="text-2xl font-bold text-center text-orange-600 mb-6"> Auth APP</h2>

    <!-- Register Form -->
    <form id="registerForm" class="space-y-4 hidden">
      <input 
        type="email" id="regEmail" placeholder="Email"
        class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
        required
      />
      <input 
        type="password" id="regPassword" placeholder="Password"
        class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
        required
      />
      <select id="regRole" class="w-full border rounded-lg p-2">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button 
        type="submit"
        class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition">
        Register
      </button>
      <p class="text-sm text-center text-gray-600">
        Already have an account? 
        <a href="#" id="showLogin" class="text-orange-500 hover:underline">Login</a>
      </p>
    </form>

    <!-- Login Form -->
    <form id="loginForm" class="space-y-4">
      <input 
        type="email" id="logEmail" placeholder="Email"
        class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
        required
      />
      <input 
        type="password" id="logPassword" placeholder="Password"
        class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
        required
      />
      <button 
        type="submit"
        class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition">
        Login
      </button>
      <p class="text-sm text-center text-gray-600">
        Don’t have an account? 
        <a href="#" id="showRegister" class="text-orange-500 hover:underline">Register</a>
      </p>
    </form>

    <!-- Response Box -->
    <div id="responseBox" class="mt-4 text-center text-sm text-gray-700"></div>
  </div>

  <script>
    const API_URL = "https://smartapp-nkrd.onrender.com"; // Backend URL

    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const responseBox = document.getElementById("responseBox");

    document.getElementById("showRegister").addEventListener("click", () => {
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
    });

    document.getElementById("showLogin").addEventListener("click", () => {
      registerForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
    });

    // Handle Register
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;
      const role = document.getElementById("regRole").value;

      const res = await fetch(`${API_URL}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, role }),
      });
      const data = await res.json();
      responseBox.innerText = data.message || data.error;
    });

    // Handle Login
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("logEmail").value;
  const password = document.getElementById("logPassword").value;

  const res = await fetch(`${API_URL}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });
  const data = await res.json();
  console.log("Login response:", data);

  if (data.token) {
    // ✅ Clear any old data first
    localStorage.clear();
    
    // ✅ خزّن البيانات
    localStorage.setItem("token", data.token);
    localStorage.setItem("role", data.user.role);
    localStorage.setItem("user_email", data.user.email);
    
    console.log("Debug - Stored user data:", {
      token: data.token ? "✓" : "✗",
      role: data.user.role,
      email: data.user.email
    });

    responseBox.innerText = "✅ Login successful! Redirecting...";

    // ✅ تحويل لصفحة واحدة
    window.location.href = "/dashboard.html";
  } else {
    responseBox.innerText = data.error || "Something went wrong";
  }
});

  </script>
</body>
</html>
